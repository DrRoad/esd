## Name		: Retrieve
## Description	: S3 method used to retrieve data from netcdf file. The default method was set to the old version of retrieve i.e. retrieve.nc in previous clim.pact package 
## Author 	: A. Mezghani, MET NORWAY
## contact 	: abdelkaderm@met.no
## Created      : 21-03-2013
## Last Update	: 25-04-2013 ; 15-05-2014
## require	: zoo, summary_ncdf4 , check_ncdf4
## input	: a zoo field object / 3 dimensional field with dimensions (time,lon,lat)

## depends on both ncdf and ncdf4 library, one of the two must be installed

## Define retrieve as method
retrieve <- function(ncfile=NULL,...) UseMethod("retrieve")

## Default function
retrieve.default <- function(ncfile,param="auto",type="ncdf",verbose=FALSE,...) {
    ##
    X <- NULL
    
    if (is.character(ncfile)) {
        fext <- substr(ncfile,nchar(ncfile)-1,nchar(ncfile))
        stopifnot(fext=="nc")
    }
    
    test <- NULL
    
    if ((type=="ncdf") | (class(ncfile)=="ncdf")) { ##(library("ncdf",logical.return=TRUE)) {
        nc <- open.ncdf(ncfile)
        dimnames <- names(nc$dim)
        lon <- get.var.ncdf(nc,dimnames[grep("lon",dimnames)])
        lat <- get.var.ncdf(nc,dimnames[grep("lat",dimnames)])
    } else if ((type=="ncdf4") | (class(ncfile)=="ncdf4")) {##(library("ncdf4",logical.return=TRUE)) {
        nc <- nc_open(ncfile)
        dimnames <- names(nc$dim)
        lon <- ncvar_get(nc,dimnames[grep("lon",dimnames)])
        lat <- ncvar_get(nc,dimnames[grep("lat",dimnames)])
    }
    if ( (length(dim(lon))==1) & (length(dim(lat))==1) ) {
        if (verbose) print('Regular grid field found')
        X <- retrieve(ncfile,param=param,verbose=verbose,type=type,...)
    } else {
        if (verbose) print('Irregular grid field found')
        X <- retrieve.rcm(ncfile,param=param,verbose=verbose,...) 
    }
    } else if ((type=="ncdf4") | (class(ncfile)=="ncdf4")) {##(library("ncdf4",logical.return=TRUE)) {
        nc <- nc_open(ncfile)
        dimnames <- names(nc$dim)
        lon <- ncvar_get(nc,dimnames[grep("lon",dimnames)])
        lat <- ncvar_get(nc,dimnames[grep("lat",dimnames)])
        if ( (length(dim(lon))==1) & (length(dim(lat))==1) )  {
            if (verbose) print('Regular grid field found')
            X <- retrieve.ncdf4(ncfile,param=param,verbose=verbose,...)
        }
        else {
            if (verbose) print('Irregular grid field found')
            X <- retrieve.rcm(ncfile,param=param,verbose=verbose,...) 
        }
    }
    else print("No suitable ncdf or ncdf4 libraries found to read your file or data")
    
}

